{% extends "base.html" %}

{% block title %}{{ feature_request.title }} - Feature Requestor{% endblock %}

{% block content %}
<div class="feature-request-detail">
    <h1>{{ feature_request.title }}</h1>
    <div class="request-info">
        <p><strong>App:</strong> {{ feature_request.app.app_display_name }}</p>
        <p><strong>Type:</strong> {{ feature_request.request_type }}</p>
        <p><strong>Category:</strong> {{ feature_request.request_category }}</p>
        <p><strong>Status:</strong> {{ feature_request.status }}</p>
        <p><strong>Total Bid:</strong> {{ format_currency(converted_total_bid, viewing_currency) }} {% if viewing_currency != 'CAD' %}<small>(converted from original currencies)</small>{% endif %}</p>
        {% if feature_request.projected_completion_date %}
            <p><strong>Projected Completion:</strong> {{ feature_request.projected_completion_date.strftime('%Y-%m-%d %H:%M:%S') }}</p>
        {% endif %}
        {% if feature_request.delivered_date %}
            <p><strong>Delivered:</strong> {{ feature_request.delivered_date.strftime('%Y-%m-%d %H:%M:%S') }}</p>
        {% endif %}
    </div>
    
    {% if current_user.is_authenticated %}
        <div class="request-actions">
            {% if current_user.role == 'requester' and feature_request.status == 'completed' and user_bid %}
                <form method="POST" action="{{ url_for('feature_requests.confirm_request', request_id=feature_request.id) }}" style="display:inline;">
                    <button type="submit" class="btn btn-success">Confirm Completion</button>
                </form>
            {% endif %}
            
            {% if current_user.role == 'dev' %}
                {% if not is_dev %}
                    <form method="POST" action="{{ url_for('feature_requests.add_developer', request_id=feature_request.id) }}" style="display:inline;">
                        <button type="submit" class="btn btn-primary">Add Myself as Developer</button>
                    </form>
                {% else %}
                    <a href="{{ url_for('feature_requests.edit_request', request_id=feature_request.id) }}" class="btn btn-secondary">Edit Request Details</a>
                    <form method="POST" action="{{ url_for('feature_requests.set_status', request_id=feature_request.id) }}" style="display:inline;">
                        <select name="status">
                            <option value="requested" {% if feature_request.status == 'requested' %}selected{% endif %}>Requested</option>
                            <option value="in_progress" {% if feature_request.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                            <option value="completed" {% if feature_request.status == 'completed' %}selected{% endif %}>Completed</option>
                            <option value="cancelled" {% if feature_request.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                        </select>
                        {% if feature_request.status == 'in_progress' %}
                            <label for="projected_date">Projected Completion:</label>
                            <input type="date" id="projected_date" name="projected_completion_date" 
                                   value="{{ feature_request.projected_completion_date.strftime('%Y-%m-%d') if feature_request.projected_completion_date else '' }}">
                        {% endif %}
                        <button type="submit" class="btn btn-primary">Update Status</button>
                    </form>
                    <form method="POST" action="{{ url_for('feature_requests.remove_developer', request_id=feature_request.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to remove yourself from this request?');">
                        <button type="submit" class="btn btn-danger">Remove Myself</button>
                    </form>
                {% endif %}
            {% endif %}
        </div>
    {% endif %}
    
    <div class="comments-section">
        <h2>Comments</h2>
        {% for comment in comments %}
            <div class="comment {% if comment.is_deleted %}deleted{% endif %}">
                <div class="comment-header">
                    <strong class="user-name" data-user-id="{{ comment.commenter.id }}" data-user-name="{{ comment.commenter.username }}">{{ comment.commenter.username }}</strong>
                    <span class="comment-date">{{ comment.date.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                    {% if comment.is_edited %}
                        <span class="comment-edited">(edited)</span>
                    {% endif %}
                    {% if comment.is_deleted %}
                        <span class="comment-deleted">(deleted)</span>
                    {% endif %}
                </div>
                {% if comment.is_deleted %}
                    <div class="comment-body deleted-text">This comment has been deleted.</div>
                    {% if comment.original_comment %}
                        <button class="btn btn-sm btn-link show-original" onclick="toggleOriginal({{ comment.id }})">Show original</button>
                        <div id="original-{{ comment.id }}" style="display:none;" class="original-comment">{{ comment.original_comment|safe }}</div>
                    {% endif %}
                {% else %}
                    <div class="comment-body">{{ comment.comment|safe }}</div>
                    {% if comment.is_edited and comment.original_comment %}
                        <button class="btn btn-sm btn-link show-original" onclick="toggleOriginal({{ comment.id }})">Show original</button>
                        <div id="original-{{ comment.id }}" style="display:none;" class="original-comment">{{ comment.original_comment|safe }}</div>
                    {% endif %}
                {% endif %}
                {% if comment.bid_amount > 0 %}
                    <div class="comment-bid">
                        Bid: {{ format_currency(comment.bid_amount, comment.bid_currency or 'CAD') }}
                        {% if current_user.is_authenticated and comment.bid_currency and comment.bid_currency != viewing_currency %}
                            ({{ format_currency(convert_currency(comment.bid_amount, comment.bid_currency, viewing_currency), viewing_currency) }})
                        {% endif %}
                    </div>
                {% endif %}
                {% if current_user.is_authenticated and comment.commenter_id == current_user.id and current_user.role == 'requester' and feature_request.status == 'requested' and not comment.is_deleted %}
                    <div class="comment-actions">
                        <a href="{{ url_for('feature_requests.edit_comment', request_id=feature_request.id, comment_id=comment.id) }}" class="btn btn-sm btn-secondary">Edit</a>
                        <form method="POST" action="{{ url_for('feature_requests.delete_comment', request_id=feature_request.id, comment_id=comment.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this comment?');">
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    </div>
    
    <script>
        function toggleOriginal(commentId) {
            const original = document.getElementById('original-' + commentId);
            const button = event.target;
            if (original.style.display === 'none') {
                original.style.display = 'block';
                button.textContent = 'Hide original';
            } else {
                original.style.display = 'none';
                button.textContent = 'Show original';
            }
        }
    </script>
    
    {% if current_user.is_authenticated %}
        {% if current_user.email_verified %}
            <div class="add-comment">
                <h3>Add Comment</h3>
                <form method="POST" action="{{ url_for('feature_requests.add_comment', request_id=feature_request.id) }}">
                    <div class="form-group">
                        <label for="comment">Comment:</label>
                        <textarea id="comment" name="comment" class="rich-text-editor" data-height="300px" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="bid_amount">Bid Amount (optional):</label>
                        <input type="number" id="bid_amount" name="bid_amount" min="0" step="0.01" value="0" 
                               {% if not current_user.stripe_account_id %}disabled title="You must connect a Stripe account to bid"{% endif %}>
                        {% if not current_user.stripe_account_id %}
                            <small>You must connect a Stripe account to place bids.</small>
                        {% endif %}
                    </div>
                    <button type="submit" class="btn btn-primary">Add Comment</button>
                </form>
            </div>
        {% else %}
            <div class="add-comment">
                <h3>Add Comment</h3>
                <div class="alert alert-warning">
                    <p>Please verify your email address before adding comments or placing bids.</p>
                    <p><a href="{{ url_for('account.settings') }}">Go to account settings to verify your email</a></p>
                </div>
            </div>
        {% endif %}
    {% else %}
        <p><a href="{{ url_for('auth.login') }}">Sign in</a> to add comments.</p>
    {% endif %}
    
    {% if current_user.is_authenticated and (is_dev or current_user.role == 'admin') and developers|length > 1 %}
        <div class="payment-ratios-section">
            <h2>Payment Ratio Management</h2>
            <p>This section is only visible to developers and admins.</p>
            <a href="{{ url_for('feature_requests.payment_ratios', request_id=feature_request.id) }}" class="btn btn-primary">Manage Payment Ratios</a>
        </div>
    {% endif %}
    
    {% if current_user.is_authenticated and (is_dev or current_user.role == 'admin') and developer_history %}
        <div class="developer-history-section">
            <h2>Developer History</h2>
            <button class="btn btn-link" onclick="toggleHistory()">Show/Hide Previous Developers</button>
            <div id="developer-history" style="display:none;">
                <ul>
                    {% for hist in developer_history %}
                        <li>
                            <span class="user-name" data-user-id="{{ hist.developer.id }}" data-user-name="{{ hist.developer.name }}">{{ hist.developer.name }}</span> - 
                            Started: {{ hist.started_at.strftime('%Y-%m-%d') }}, 
                            Removed: {{ hist.removed_at.strftime('%Y-%m-%d') }} 
                            (by {{ hist.removed_by }})
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    {% endif %}
    
    <script>
        function toggleHistory() {
            const history = document.getElementById('developer-history');
            if (history.style.display === 'none') {
                history.style.display = 'block';
            } else {
                history.style.display = 'none';
            }
        }
    </script>
{% endblock %}

{% block extra_scripts %}
<script>
// Right-click context menu for messaging
document.addEventListener('contextmenu', function(e) {
    const userNameElement = e.target.closest('.user-name');
    if (userNameElement && {{ current_user.is_authenticated|tojson }}) {
        e.preventDefault();
        const userId = userNameElement.dataset.userId;
        const userName = userNameElement.dataset.userName;
        
        // Remove existing menu if any
        const existingMenu = document.getElementById('context-menu');
        if (existingMenu) {
            existingMenu.remove();
        }
        
        // Create context menu
        const menu = document.createElement('div');
        menu.id = 'context-menu';
        menu.style.position = 'fixed';
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
        menu.style.backgroundColor = '#fff';
        menu.style.border = '1px solid #ddd';
        menu.style.borderRadius = '4px';
        menu.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
        menu.style.zIndex = '10000';
        menu.style.padding = '0.5rem 0';
        menu.style.minWidth = '150px';
        
        const menuItem = document.createElement('a');
        // Check if create route exists, otherwise use index with params
        menuItem.href = '{{ url_for("messages.index") }}?action=new&user_id=' + userId;
        menuItem.onclick = function(e) {
            e.preventDefault();
            // Open messages page with user pre-selected
            window.location.href = '{{ url_for("messages.index") }}?action=new&user_id=' + userId;
        };
        menuItem.textContent = 'Message ' + userName;
        menuItem.style.display = 'block';
        menuItem.style.padding = '0.5rem 1rem';
        menuItem.style.textDecoration = 'none';
        menuItem.style.color = '#333';
        menuItem.onmouseover = function() { this.style.backgroundColor = '#f0f0f0'; };
        menuItem.onmouseout = function() { this.style.backgroundColor = 'transparent'; };
        
        menu.appendChild(menuItem);
        document.body.appendChild(menu);
        
        // Close menu on click outside
        const closeMenu = function(e) {
            if (!menu.contains(e.target) && e.target !== userNameElement) {
                menu.remove();
                document.removeEventListener('click', closeMenu);
            }
        };
        setTimeout(() => document.addEventListener('click', closeMenu), 100);
    }
});

    // Rich text editor is automatically initialized by rich-text-editor.js
</script>
{% endblock %}

